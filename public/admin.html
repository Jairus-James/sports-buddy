<!DOCTYPE html>
<html>
  <head>
    <title>Sports Buddy | Admin Dashboard</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@picocss/pico@1/css/pico.min.css" />
    <link rel="stylesheet" href="./styles/main.css" />
  </head>
  <body>
    <main class="container admin">
      <nav>
        <ul>
          <li><h1>Admin Dashboard</h1></li>
        </ul>
        <ul>
          <li><a href="#" id="logoutBtn" role="button">Log out</a></li>
        </ul>
      </nav>

      <p>Manage application data from this dashboard.</p>

      <div class="grid">
        <article>
          <h2>Categories</h2>
          <form id="addCategoryForm">
            <label for="categoryName">Add New Category</label>
            <input type="text" id="categoryName" placeholder="Category Name" required />
            <button type="submit">Add Category</button>
            <div id="categoryMessage" class="message"></div>
          </form>
          <hr />
          <h3>Existing Categories</h3>
          <div id="categoryList"></div>
        </article>

        <article>
          <h2>Cities & Areas</h2>
          <form id="addCityForm">
            <label for="cityName">Add New City</label>
            <input type="text" id="cityName" placeholder="City Name" required />
            <textarea id="cityAreas" placeholder="Enter initial areas, comma-separated" required></textarea>
            <button type="submit">Add City</button>
            <div id="cityMessage" class="message"></div>
          </form>
          <hr />
          <h3>Manage Areas</h3>
          <label for="citySelect">Select a City</label>
          <select id="citySelect" required>
            <option value="" disabled selected>Loading cities...</option>
          </select>
          <div id="areaManagement" class="hidden">
            <form id="addAreaForm">
              <label for="newAreaName">Add New Area</label>
              <input type="text" id="newAreaName" placeholder="Area Name" required />
              <button type="submit">Add Area</button>
              <div id="areaMessage" class="message"></div>
            </form>
            <h4>Existing Areas</h4>
            <div id="areaList"></div>
          </div>
        </article>
      </div>

      <article>
        <header>
          <div class="grid">
            <h2>Manage Sport Events</h2>
            <button id="createEventBtn">Create New Event</button>
          </div>
        </header>
        <p>Below is a list of all created sport events. You can edit or delete them from here.</p>
        <div id="eventList"></div>
        <div id="deleteMessage" class="message"></div>
      </article>
    </main>

    <dialog id="eventModal">
      <article>
        <header>
          <a href="#close" aria-label="Close" class="close" id="closeModalBtn"></a>
          <h2 id="modalTitle">Edit Event</h2>
        </header>
        <form id="eventForm">
          <input type="hidden" id="eventId" />
          <label for="eventName">Event Name</label>
          <input type="text" id="eventName" required />

          <label for="eventCategory">Category</label>
          <select id="eventCategory" required></select>

          <label for="eventCity">City</label>
          <select id="eventCity" required></select>

          <label for="eventArea">Area</label>
          <select id="eventArea" required></select>

          <label for="eventDate">Date & Time</label>
          <input type="datetime-local" id="eventDateTime" required />

          <button type="submit" id="saveEventBtn">Save Changes</button>
        </form>
      </article>
    </dialog>

    <script type="module">
      import { onAuth, getUserRole } from "./scripts/auth.js";
      import { auth } from "./scripts/firebaseConfig.js";
      import { signOut } from "https://www.gstatic.com/firebasejs/10.7.0/firebase-auth.js";
      import {
        addCategory,
        getCategories,
        deleteCategory,
        addCity,
        getCities,
        addAreaToCity,
        removeAreaFromCity,
        addEvent,
        getEvents,
        updateEvent,
        deleteSport,
      } from "./scripts/admin.js";

      onAuth(async (user) => {
        if (!user) {
          window.location.href = "index.html";
          return;
        }
        currentUser = user;
        const role = await getUserRole(user.uid);
        if (role !== "admin") {
          alert("Access Denied. You are not an admin.");
          window.location.href = "dashboard.html";
        }
      });

      document.getElementById("logoutBtn").addEventListener("click", (e) => {
        e.preventDefault();
        signOut(auth).catch((error) => console.error("Logout error", error));
      });

      const categoryListEl = document.getElementById("categoryList");
      const citySelectEl = document.getElementById("citySelect");
      const areaManagementEl = document.getElementById("areaManagement");
      const areaListEl = document.getElementById("areaList");
      const eventListEl = document.getElementById("eventList");
      const eventModal = document.getElementById("eventModal");
      const eventForm = document.getElementById("eventForm");
      let currentUser = null;
      let citiesData = [];
      let allEvents = [];

      document.getElementById("closeModalBtn").addEventListener("click", (e) => {
        e.preventDefault();
        eventModal.close();
      });

      document.getElementById("createEventBtn").addEventListener("click", () => {
        eventForm.reset();
        document.getElementById("eventId").value = "";
        document.getElementById("modalTitle").textContent = "Create Event";
        eventModal.showModal();
      });

      document.getElementById("eventCity").addEventListener('change', (e) => {
        const selectedCity = citiesData.find(c => c.id === e.target.value);
        document.getElementById("eventArea").innerHTML = selectedCity?.areas.map(a => `<option value="${a}">${a}</option>`).join('') || '';
      });

      document.getElementById("addCategoryForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("categoryName").value;
        const messageEl = document.getElementById("categoryMessage");
        messageEl.textContent = "";
        try {
          await addCategory(name);
          messageEl.textContent = `Category "${name}" added successfully.`;
          messageEl.className = "message success";
          e.target.reset();
          loadCategories();
        } catch (error) {
          messageEl.textContent = "Error adding category.";
          messageEl.className = "message error";
          console.error(error);
        }
      });

      document.getElementById("addCityForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const name = document.getElementById("cityName").value;
        const areas = document.getElementById("cityAreas").value.split(",").map((area) => area.trim()).filter(Boolean);
        const messageEl = document.getElementById("cityMessage");
        messageEl.textContent = "";
        try {
          await addCity(name, areas);
          messageEl.textContent = `City "${name}" added/updated successfully.`;
          messageEl.className = "message success";
          e.target.reset();
          loadCities();
        } catch (error) {
          messageEl.textContent = "Error adding city.";
          messageEl.className = "message error";
          console.error(error);
        }
      });

      document.getElementById("addAreaForm").addEventListener("submit", async (e) => {
        e.preventDefault();
        const selectedCityName = citySelectEl.value;
        const newAreaName = document.getElementById("newAreaName").value;
        const messageEl = document.getElementById("areaMessage");
        messageEl.textContent = "";

        if (!selectedCityName || !newAreaName) return;

        try {
          await addAreaToCity(selectedCityName, newAreaName);
          messageEl.textContent = `Area "${newAreaName}" added.`;
          messageEl.className = "message success";
          e.target.reset();
          const city = citiesData.find((c) => c.id === selectedCityName);
          if (city && !city.areas.includes(newAreaName)) {
            city.areas.push(newAreaName);
          }
          renderAreas(city.areas);
        } catch (error) {
          messageEl.textContent = "Failed to add area.";
          messageEl.className = "message error";
          console.error(error);
        }
      });

      categoryListEl.addEventListener("click", async (e) => {
        if (e.target.tagName === "BUTTON" && e.target.dataset.id) {
          const categoryId = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this category?")) {
            try {
              await deleteCategory(categoryId);
              loadCategories();
            } catch (error) {
              alert("Failed to delete category.");
              console.error(error);
            }
          }
        }
      });

      citySelectEl.addEventListener("change", (e) => {
        const selectedCityName = e.target.value;
        if (!selectedCityName) {
          areaManagementEl.classList.add("hidden");
          return;
        }
        const selectedCity = citiesData.find((city) => city.id === selectedCityName);
        if (selectedCity) {
          renderAreas(selectedCity.areas);
          areaManagementEl.classList.remove("hidden");
        }
      });

      areaListEl.addEventListener("click", async (e) => {
        if (e.target.tagName === "BUTTON" && e.target.dataset.name) {
          const selectedCityName = citySelectEl.value;
          const areaName = e.target.dataset.name;
          if (confirm(`Are you sure you want to delete the area "${areaName}"?`)) {
            try {
              await removeAreaFromCity(selectedCityName, areaName);
              const city = citiesData.find((c) => c.id === selectedCityName);
              if (city) {
                city.areas = city.areas.filter((a) => a !== areaName);
              }
              renderAreas(city.areas);
            } catch (error) {
              alert("Failed to delete area.");
              console.error(error);
            }
          }
        }
      });

      eventListEl.addEventListener("click", async (e) => {
        if (e.target.tagName === "BUTTON" && e.target.dataset.action === "delete") {
          const eventId = e.target.dataset.id;
          if (confirm("Are you sure you want to delete this event?")) {
            const messageEl = document.getElementById("deleteMessage");
            messageEl.textContent = "";
            try {
              await deleteSport(eventId);
              messageEl.textContent = `Event "${eventId}" deleted successfully.`;
              messageEl.className = "message success";
              loadEvents();
            } catch (error) {
              messageEl.textContent = "Error deleting event.";
              messageEl.className = "message error";
              console.error(error);
            }
          }
        }

        if (e.target.tagName === "BUTTON" && e.target.dataset.action === "edit") {
          const eventId = e.target.dataset.id;
          const eventToEdit = allEvents.find(event => event.id === eventId);
          document.getElementById("modalTitle").textContent = "Edit Event";
          if (eventToEdit) {
            document.getElementById("eventId").value = eventToEdit.id;
            document.getElementById("eventName").value = eventToEdit.name;
            document.getElementById("eventCategory").value = eventToEdit.category;
            document.getElementById("eventCity").value = eventToEdit.city;
            document.getElementById("eventCity").dispatchEvent(new Event('change'));
            setTimeout(() => {
              document.getElementById("eventArea").value = eventToEdit.area;
            }, 100);
            document.getElementById("eventDateTime").value = eventToEdit.dateTime;
            eventModal.showModal();
          }
        }
      });

      eventForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const eventId = document.getElementById("eventId").value;
        let eventData = {
          name: document.getElementById("eventName").value,
          category: document.getElementById("eventCategory").value,
          city: document.getElementById("eventCity").value,
          area: document.getElementById("eventArea").value,
          dateTime: document.getElementById("eventDateTime").value,
        };

        const messageEl = document.getElementById("deleteMessage");
        try {
          if (eventId) {
            await updateEvent(eventId, eventData);
            messageEl.textContent = "Event updated successfully!";
          } else {
            eventData.userId = currentUser.uid;
            await addEvent(eventData);
            messageEl.textContent = "Event created successfully!";
          }
          messageEl.className = "message success";
          eventModal.close();
          loadEvents();
        } catch (error) {
          const action = eventId ? 'update' : 'create';
          console.error(`Error ${action} event:`, error);
          messageEl.textContent = `Failed to ${action} event.`;
          messageEl.className = "message error";
        }
      });
      function renderCategories(categories) {
        categoryListEl.innerHTML = categories.map((cat) => `
          <div class="list-item">
            <span>${cat.name}</span>
            <button class="secondary outline small" data-id="${cat.id}">Delete</button>
          </div>
        `).join("");
      }

      function renderAreas(areas) {
        if (!areas || areas.length === 0) {
          areaListEl.innerHTML = "<p>No areas found for this city.</p>";
          return;
        }
        areaListEl.innerHTML = areas.map((area) => `
          <div class="list-item">
            <span>${area}</span>
            <button class="secondary outline small" data-name="${area}">Delete</button>
          </div>
        `).join("");
      }

      function renderEvents(events) {
        if (!events || events.length === 0) {
          eventListEl.innerHTML = "<p>No sport events found.</p>";
          return;
        }
        eventListEl.innerHTML = events.map((event) => `
          <div class="list-item">
            <span><strong>${event.name || 'Unnamed Event'}</strong> (Category: ${event.category || 'N/A'})</span>
            <div>
              <button class="small" data-action="edit" data-id="${event.id}">Edit</button>
              <button class="secondary outline small" data-action="delete" data-id="${event.id}">Delete</button>
            </div>
          </div>
        `).join("");
      }

      async function loadCategories() {
        try {
          renderCategories(await getCategories());
        } catch (error) {
          console.error("Error loading categories:", error);
          categoryListEl.innerHTML = '<p class="error-text">Could not load categories.</p>';
        }
      }

      async function loadCities() {
        try {
          citiesData = await getCities();
          citySelectEl.innerHTML = '<option value="" disabled selected>Select a city</option>';
          citiesData.forEach((city) => {
            const option = document.createElement("option");
            option.value = city.id;
            option.textContent = city.id;
            citySelectEl.appendChild(option);
          });
        } catch (error) {
          console.error("Error loading cities:", error);
          citySelectEl.innerHTML = '<option value="" disabled selected>Could not load cities</option>';
        }
      }

      async function loadEvents() {
        try {
          allEvents = await getEvents();
          renderEvents(allEvents);
        } catch (error) {
          console.error("Error loading events:", error);
          eventListEl.innerHTML = '<p class="error-text">Could not load events.</p>';
        }
      }

      async function loadDropdownsForModal() {
        const [categories, cities] = await Promise.all([getCategories(), getCities()]);
        citiesData = cities;

        const categorySelect = document.getElementById("eventCategory");
        categorySelect.innerHTML = categories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');

        const citySelect = document.getElementById("eventCity");
        citySelect.innerHTML = cities.map(c => `<option value="${c.id}">${c.id}</option>`).join('');
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadCategories();
        loadCities();
        loadEvents();
        loadDropdownsForModal();
      });
    </script>
  </body>
</html>
